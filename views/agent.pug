doctype html 
html 
    head 
        title Agent Code - Imagine Dungeons 
        link(rel="stylesheet" href="/static/css/agent_style.css")
        link(rel="stylesheet" href="/static/css/style.css")
        link(rel="icon" type="image/x-icon" href="/static/images/favicon.ico")
        script(src="https://kit.fontawesome.com/534e6fef90.js" crossorigin="anonymous")

        link(rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.11.0/css/all.css")
        
        link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.57.0/codemirror.min.css")
        link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.57.0/theme/darcula.css")
        script(src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.57.0/codemirror.min.js")
        script(src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.57.0/mode/javascript/javascript.min.js")

        script(src="https://cdn.jsdelivr.net/npm/chart.js")
    body 
        include includes/nav
        span(hidden)#ready
        .agent(id_agent=agent._id)
            button(onclick="startIntro()").intro
                i.far.fa-question-circle
            .code.box
                .header
                    div(style="display: inline;")
                        input(type="text" id="agent_name" name="agent_name" value=agent.name placeholder="Agent Name") 
                        | .js
                    div(style="display: flex; align-items: center;")
                        button#undo
                            i.fas.fa-trash-undo
                        button#save
                            i.fas.fa-save
                        button#files
                            i.fas.fa-chevron-down
                        
                .code_textarea
                    ul.algo_options(hidden)
                        .division Your Files
                        li.algo_option(code="main")#main
                        .division Examples
                        li.algo_option(code="dqn") DQN Agent
                        li.algo_option(code="placeholder") Q-learning 

                    textarea(id="code")=agent.code

            .right
                .choice
                    label(for="game_name") Choose a game
                    br
                    select(name="game_name" id="game_name")
                        if games
                            each game in games 
                                option(value=game._id selected=(game._id == id_game) ? true : false)=game.name
                    button#run
                        | RUN CODE &nbsp;
                        i.fas.fa-play 

                .top
                    .game.box 
                        .header GAME
                        .cont_container
                            .canva_container
                                canvas#playCanvas
                    .render.box 
                        .header RENDER 
                        .render_container
                            canvas#renderCanvas

                .bottom
                    .plot.box
                        .header PLOT
                        .plot_container 
                            canvas#myChart

                    .metrics.box
                        .header METRICS 
                        .metrics_container 
                            .metric
                                .metric_cont
                                    i.metric_icon.fad.fa-clock
                                    div
                                        .metric_title Time
                                        .metric_value#time
                                    
                            .metric 
                                .metric_cont
                                    i.metric_icon.fad.fa-heartbeat
                                    div
                                        .metric_title Life
                                        .metric_value#life

                            .metric 
                                .metric_cont
                                    i.metric_icon.fad.fa-star
                                    div
                                        .metric_title XP
                                        .metric_value#xp

                            .metric 
                                .metric_cont
                                    i.metric_icon.fad.fa-medal
                                    div
                                        .metric_title Level
                                        .metric_value#level

                            .metric 
                                .metric_cont
                                    i.metric_icon.fad.fa-sword
                                    div
                                        .metric_title Attack
                                        .metric_value#attack

                            .metric 
                                .metric_cont
                                    i.metric_icon.fad.fa-shield
                                    div
                                        .metric_title Defense
                                        .metric_value#defense
    script.
        window.codes = !{JSON.stringify(codes)}

        window.editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            mode: "javascript",
            lineNumbers: true,
            theme: 'darcula',
            autocorrect: true,
            indentUnit: 2
        });

    script(src="/static/bundles/agent_client_bundle.js")
    script(src="/static/js/intro.js")
    script. 

        function setSizeCanvas(){
            var canvas = document.getElementById("playCanvas")
            var width = canvas.parentNode.parentNode.clientWidth

            var unit = Math.round(width/4);

            canvas.parentNode.style.height = unit*3 + "px"

            var render_canvas = document.getElementById("renderCanvas")
            render_canvas.style.height = canvas.parentNode.style.height
        }

        setSizeCanvas()

        window.addEventListener('resize', () =>
        {
            setSizeCanvas()
        })

        const ctx = document.getElementById('myChart').getContext('2d');

        const data = {
        labels: [],
        datasets: [{
            label: 'Rewards per Episode',
            data: [],
            backgroundColor: 'rgba(177, 83, 40, 0.2)',
            borderColor: 'rgba(177, 83, 40, 1)',
            borderWidth: 1
        }]
        };

        const options = {
            maintainAspectRatio: false,
            responsive: true,  
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Episode #'
                    },
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 10
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Cumulative Reward'
                    },
                    ticks: {
                        beginAtZero: true
                    }
                }
            }
        };

        window.chart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: options
        });

        function startIntro(){
            if (document.getElementsByClassName("choice")[0].style.display == "none"){
                training();
            }
            else {
                coding();
            }
        }

        function coding(){
            introJs().setOptions({
                showProgress: true,
                exitOnOverlayClick: true,
                steps: [
                { 
                    title: "Welcome",
                    intro: "Unleash your creativity and bring your dungeon game vision to life! On this game editing page, you have the tools to create a customized 3D dungeon game that includes an architecture for training an AI agent."
                },
                {
                    element: '.settings',
                    title: "General Game Settings",
                    intro: 'Here you can customize the general game settings to your liking.',
                    position: 'right'
                },
                {
                    element: '.assets',
                    title: "Choose Your Game Assets",
                    intro: "This section is home to a diverse collection of assets, organized into categories for easy browsing. Simply click on your desired asset to add it to the center of your game.",
                    position: 'left'
                },
                {
                    element: '.canva',
                    title: "Game Layout",
                    intro: "Once you add an asset, it will appear in the center of the layout, but you have the power to rearrange it to your liking. Easily change the position of an asset by dragging it or by clicking 'G'. You can also adjust the rotation of an asset by dragging the green circle under it or by clicking 'R' if the circle is not already visible.",
                    position: 'bottom'
                },
                {
                    element: '.project',
                    title: "Manage Your Assets",
                    intro: "In this section, you can view all the assets that are currently in your game, including the ability to select and highlight specific assets. Additionally, you have the power to remove any unwanted assets.",
                    position: 'top'
                },
                {
                    element: '.properties',
                    title: "Asset properties",
                    intro: "Whenever you select an asset, this section will display its properties for you to review and adjust as needed.",
                    position: 'right'
                },
                {
                    element: '#save',
                    title: "Save Your Game",
                    intro: "This game editing page doesn't save automatically, so be sure to click on the 'SAVE' button to preserve your progress and ensure you don't lose any of your edits. Please note that it may take a few seconds to save.",
                    position: 'bottom'
                },
                {
                    element: '#play',
                    title: "Play Your Game",
                    intro: "Simply click the 'PLAY' button to enter the world you've created. This is a similar interface the AI will have access, so you can see how it performs in the environment you've created.",
                    position: 'bottom'
                }
                
                ]
            }).start()
        }

        function training(){

        }